{% extends "admin/admin_base.html" %}

{% block title %}Manajemen Pengguna - Admin Digi Pustaka{% endblock %}

{% block page_title %}Manajemen Pengguna{% endblock %}

{% block content %}
<div class="table-responsive-wrapper">
    <table class="data-table">
        <thead>
            <tr>
                <th>ID User</th>
                <th>Nama Lengkap</th>
                <th>Email</th>
                <th>No. Anggota</th>
                <th>Role</th>
                <th>Status Akun</th>
                <th>Tgl Daftar</th>
                <th>Aksi</th>
            </tr>
        </thead>
        <tbody>
            {% if users %}
                {% for user_row in users %} {# Mengganti 'user' menjadi 'user_row' untuk menghindari konflik dengan g.user #}
                <tr>
                    <td>{{ user_row['user_id'] }}</td>
                    <td>{{ user_row['nama_lengkap'] }}</td>
                    <td>{{ user_row['email'] }}</td>
                    <td>{{ user_row['nomor_anggota'] }}</td>
                    <td>{{ user_row['role'] | title }}</td>
                    <td>{% if user_row['is_active'] == 1 %}Aktif{% else %}Nonaktif{% endif %}</td>
                    {# Menggunakan 'created_at' dan memformatnya #}
                    <td>{{ user_row['created_at'].split(' ')[0] if user_row['created_at'] else '-' }}</td>
                    <td class="action-buttons">
                        <a href="{{ url_for('admin_user_detail', user_id=user_row['user_id']) }}" class="btn btn-detail">Detail</a>
                        
                        {# Tombol aksi hanya jika bukan pengguna yang sedang login #}
                        {% if user_row['user_id'] != g.user.user_id %} 
                            {# Tombol untuk mengubah role #}
                            <form action="{{ url_for('admin_toggle_user_role', user_id=user_row['user_id']) }}" method="post" style="display: inline;">
                                <button type="submit" class="btn {% if user_row['role'] == 'user' %}btn-admin{% else %}btn-warning{% endif %}">
                                    {% if user_row['role'] == 'user' %}Jadikan Admin{% else %}Jadikan User{% endif %}
                                </button>
                            </form>
                            
                            {# Tombol untuk mengubah status aktif/nonaktif #}
                            <form action="{{ url_for('admin_toggle_user_active_status', user_id=user_row['user_id']) }}" method="post" style="display: inline;">
                                <button type="submit" class="btn {% if user_row['is_active'] == 1 %}btn-danger{% else %}btn-admin{% endif %}">
                                    {% if user_row['is_active'] == 1 %}Nonaktifkan{% else %}Aktifkan{% endif %}
                                </button>
                            </form>
                        {% else %}
                            (Anda)
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="8" style="text-align: center; padding: 20px;">Belum ada pengguna terdaftar.</td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>
{% endblock %}
